{% extends 'base_club_dashboard.html' %}
{% load static %}
{% block links %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}
{% block content %}
<div class="{% if LANGUAGE_CODE == 'ar' %}xl:pr-[20%]{% else %}xl:pl-[20%]{% endif %} animated-bg bg-gradient-to-br from-blue-50 to-purple-50 w-full px-4 md:px-8 min-h-screen pb-12">
    <!-- Header Section -->
    <div class="py-8 animate__animated animate__fadeIn">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <div class="p-3 bg-indigo-100 rounded-full text-indigo-600">
                <i class="fas fa-concierge-bell"></i>
            </div>
            {% if LANGUAGE_CODE == 'ar' %}إضافة خدمة جديدة{% else %}Add New Service{% endif %}
        </h1>
    </div>

    <!-- Form Section -->
    <div class="animate-[fadeIn_0.8s_ease-out_0.2s_both] bg-white rounded-xl shadow-xl p-6 mx-2 md:mx-0 mb-8">
        <form method="post" enctype="multipart/form-data" class="w-full">
            {% csrf_token %}

            <!-- Image Upload Section -->
            <div class="mb-8">
                <div class="relative w-full h-64 bg-gray-100 rounded-xl overflow-hidden flex items-center justify-center" id="image-upload-area">
                    <div id="image-preview-container" class="w-full h-full flex items-center justify-center hidden">
                        <img id="image-preview" class="h-full w-full object-cover" src="" alt="Service Preview">
                        <button type="button" onclick="removeImage()" class="absolute top-4 right-4 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors duration-300">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>

                    <div id="upload-placeholder" class="text-center p-6">
                        <div class="mx-auto w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                            <i class="bi bi-image text-indigo-600 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}اسحب وأفلت صورة الخدمة هنا{% else %}Drag & drop service image here{% endif %}
                        </h3>
                        <p class="text-gray-500 mb-4">
                            {% if LANGUAGE_CODE == 'ar' %}أو{% else %}or{% endif %}
                        </p>
                        <label for="service-image" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-300 cursor-pointer">
                            {% if LANGUAGE_CODE == 'ar' %}اختر صورة{% else %}Select Image{% endif %}
                        </label>
                        <input type="file" id="service-image" accept="image/*" class="hidden" />
                        <input type="hidden" name="service_image_data" id="service-image-data">
                    </div>
                </div>
            </div>

            <!-- Form Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div>
                    <!-- Service Title -->
                    <div class="mb-6">
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}عنوان الخدمة{% else %}Service Title{% endif %}
                        </label>
                        {{form.title}}
                    </div>

                    <!-- Service Description -->
                    <div class="mb-6">
                        <label for="desc" class="block text-sm font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}وصف الخدمة{% else %}Service Description{% endif %}
                        </label>
                        {{form.desc}}
                    </div>

                    <!-- Service Classification -->
                    <div class="mb-6">
                        <label for="classification" class="block text-sm font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}تصنيف الخدمة{% else %}Service Classification{% endif %}
                        </label>
                        <select name="classification" id="id_classification" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-colors duration-300 hover:border-gray-400">
                            <option value="">
                                {% if LANGUAGE_CODE == 'ar' %}اختر التصنيف{% else %}Select Classification{% endif %}
                            </option>
                            {% for classification in form.fields.classification.queryset %}
                            <option value="{{ classification.id }}"
                                    {% if classification.id|stringformat:"s" == selected_classification_id %}selected{% endif %}>
                            {{ classification }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Right Column -->
                <div>
                    <!-- Price and Pricing Period Fields -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="price" class="block text-sm font-medium text-gray-700 mb-2">
                                {% if LANGUAGE_CODE == 'ar' %}السعر{% else %}Price{% endif %}
                            </label>
                            {{form.price}}
                        </div>
                        <div>
                            <label for="pricing_period_months" class="block text-sm font-medium text-gray-700 mb-2">
                                {% if LANGUAGE_CODE == 'ar' %}فترة التسعير{% else %}Pricing Period{% endif %}
                            </label>
                            {{form.pricing_period_months}}
                        </div>
                    </div>

                    <!-- Discounted Price -->
                    <div class="mb-6">
                        <label for="discounted_price" class="block text-sm font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}سعر مخفض (اختياري){% else %}Discounted Price (Optional){% endif %}
                        </label>
                        <input type="number" id="discounted_price" name="discounted_price" step="0.01"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-colors duration-300 hover:border-gray-400" />
                    </div>

                    <!-- Coaches Selection -->
                    <div class="mb-6">
                        <label for="coaches" class="block text-sm font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}الموظفون المسؤولون{% else %}Responsible Employees{% endif %}
                        </label>
                        <select name="coaches" id="id_coaches" multiple class="select2">
                            {% for coach in form.fields.coaches.queryset %}
                            <option value="{{ coach.id }}"
                                    {% if coach.id|stringformat:"s" in selected_coach_ids %}selected{% endif %}>
                            {{ coach }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Duration -->
                    <div class="mb-6">
                        <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}المدة (بالدقائق){% else %}Duration (in minutes){% endif %}
                        </label>
                        <input type="number" id="duration" name="duration" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-colors duration-300 hover:border-gray-400" />
                    </div>

                    <!-- Enable Service Toggle -->
                    <div class="mb-6 flex items-center">
                        <label class="flex items-center cursor-pointer">
                            <div class="relative">
                                {{form.is_enabled}}
                                <span class="toggle-label"></span>
                            </div>
                            <span class="ml-3 text-sm font-medium text-gray-700">
                                {% if LANGUAGE_CODE == 'ar' %}تفعيل الخدمة{% else %}Enable Service{% endif %}
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Pricing Summary Section -->
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-6 mb-6" id="pricing-summary" style="display: none;">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">
                    {% if LANGUAGE_CODE == 'ar' %}ملخص التسعير{% else %}Pricing Summary{% endif %}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="bg-white rounded-lg p-3">
                        <span class="text-gray-600">
                            {% if LANGUAGE_CODE == 'ar' %}السعر الشهري:{% else %}Monthly Price:{% endif %}
                        </span>
                        <div class="font-semibold text-indigo-600" id="monthly-price">$0</div>
                    </div>
                    <div class="bg-white rounded-lg p-3">
                        <span class="text-gray-600">
                            {% if LANGUAGE_CODE == 'ar' %}إجمالي الأيام:{% else %}Total Days:{% endif %}
                        </span>
                        <div class="font-semibold text-green-600" id="total-days">0</div>
                    </div>
                    <div class="bg-white rounded-lg p-3">
                        <span class="text-gray-600">
                            {% if LANGUAGE_CODE == 'ar' %}السعر النهائي:{% else %}Final Price:{% endif %}
                        </span>
                        <div class="font-semibold text-purple-600" id="final-price">$0</div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
                <a href="{% url 'viewServices' %}"
                   class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-300 font-medium">
                    {% if LANGUAGE_CODE == 'ar' %}إلغاء{% else %}Cancel{% endif %}
                </a>
                <button type="submit"
                        class="px-6 py-2 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-lg hover:from-indigo-600 hover:to-indigo-700 transition-all duration-300 font-medium shadow-md hover:shadow-lg">
                    {% if LANGUAGE_CODE == 'ar' %}إضافة الخدمة{% else %}Add Service{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Form Input Styles */
    #id_title, #id_desc, #id_price, #id_pricing_period_months, #id_coaches, #id_classification {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      transition: all 0.3s;
      background-color: #f8fafc;
    }

    #id_title:focus, #id_desc:focus, #id_price:focus, #id_pricing_period_months:focus, #id_coaches:focus, #id_classification:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
      background-color: white;
    }

    #id_title:hover, #id_desc:hover, #id_price:hover, #id_pricing_period_months:hover, #id_coaches:hover, #id_classification:hover {
      border-color: #a5b4fc;
      background-color: white;
    }

    #id_desc {
      min-height: 120px;
    }

    /* Toggle Switch */
    #id_is_enabled {
      width: 0;
      height: 0;
      opacity: 0;
      position: absolute;
    }

    #id_is_enabled + .toggle-label {
      display: inline-block;
      width: 3rem;
      height: 1.5rem;
      background-color: #e2e8f0;
      border-radius: 9999px;
      position: relative;
      transition: all 0.3s;
    }

    #id_is_enabled + .toggle-label:after {
      content: '';
      position: absolute;
      top: 0.125rem;
      left: 0.125rem;
      width: 1.25rem;
      height: 1.25rem;
      background-color: white;
      border-radius: 50%;
      transition: all 0.3s;
    }

    #id_is_enabled:checked + .toggle-label {
      background-color: #6366f1;
    }

    #id_is_enabled:checked + .toggle-label:after {
      transform: translateX(1.5rem);
    }

    /* Drag and Drop Area */
    #image-upload-area {
      border: 2px dashed #c7d2fe;
      transition: all 0.3s;
    }

    #image-upload-area:hover {
      border-color: #818cf8;
      background-color: #f0f4ff;
    }

    #image-upload-area.drag-over {
      border-color: #6366f1;
      background-color: #e0e7ff;
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
       $('#id_coaches').select2();
       updatePricingSummary(); // Initialize pricing summary
    });

   // Image Upload Functionality
   const imageUploadArea = document.getElementById('image-upload-area');
   const serviceImageInput = document.getElementById('service-image');
   const imagePreviewContainer = document.getElementById('image-preview-container');
   const imagePreview = document.getElementById('image-preview');
   const uploadPlaceholder = document.getElementById('upload-placeholder');

   // Handle drag and drop
   imageUploadArea.addEventListener('dragover', (e) => {
     e.preventDefault();
     imageUploadArea.classList.add('drag-over');
   });

   imageUploadArea.addEventListener('dragleave', () => {
     imageUploadArea.classList.remove('drag-over');
   });

   imageUploadArea.addEventListener('drop', (e) => {
     e.preventDefault();
     imageUploadArea.classList.remove('drag-over');

     if (e.dataTransfer.files.length) {
       serviceImageInput.files = e.dataTransfer.files;
       handleImageUpload(e.dataTransfer.files[0]);
     }
   });

   // Handle file selection
   serviceImageInput.addEventListener('change', (e) => {
     if (e.target.files.length) {
       handleImageUpload(e.target.files[0]);
     }
   });

   // Process the uploaded image
   function handleImageUpload(file) {
     if (file.type.match('image.*')) {
       const reader = new FileReader();

       reader.onload = function(e) {
         // Store base64 data in hidden input
         document.getElementById('service-image-data').value = e.target.result;

         // Show preview
         imagePreview.src = e.target.result;
         uploadPlaceholder.classList.add('hidden');
         imagePreviewContainer.classList.remove('hidden');
       };

       reader.readAsDataURL(file);
     }
   }

   // Remove image
   function removeImage() {
     serviceImageInput.value = '';
     document.getElementById('service-image-data').value = '';
     imagePreview.src = '';
     uploadPlaceholder.classList.remove('hidden');
     imagePreviewContainer.classList.add('hidden');
   }

   // Pricing calculation functionality
   function updatePricingSummary() {
     const priceInput = document.getElementById('id_price');
     const pricingPeriodSelect = document.getElementById('id_pricing_period_months');
     const discountedPriceInput = document.getElementById('discounted_price');

     const price = parseFloat(priceInput.value) || 0;
     const pricingPeriod = parseInt(pricingPeriodSelect.value) || 1;
     const discountedPrice = parseFloat(discountedPriceInput.value) || 0;

     const finalPrice = discountedPrice > 0 ? discountedPrice : price;
     const monthlyPrice = finalPrice / pricingPeriod;
     const totalDays = pricingPeriod * 30;

     // Update summary display
     document.getElementById('monthly-price').textContent = '$' + monthlyPrice.toFixed(2);
     document.getElementById('total-days').textContent = totalDays + ' days';
     document.getElementById('final-price').textContent = '$' + finalPrice.toFixed(2);

     // Show/hide summary based on whether we have pricing data
     const summarySection = document.getElementById('pricing-summary');
     if (price > 0) {
       summarySection.style.display = 'block';
     } else {
       summarySection.style.display = 'none';
     }
   }

   // Add event listeners for pricing inputs
   document.getElementById('id_price').addEventListener('input', updatePricingSummary);
   document.getElementById('id_pricing_period_months').addEventListener('change', updatePricingSummary);
   document.getElementById('discounted_price').addEventListener('input', updatePricingSummary);
</script>
{% endblock %}