{% extends 'base_club_dashboard.html' %}
{% load static %}
{% block links %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}

{% block content %}
<div class="{% if LANGUAGE_CODE == 'ar' %}xl:pr-[20%]{% else %}xl:pl-[20%]{% endif %} animated-bg bg-gradient-to-br from-blue-50 to-purple-50 w-full px-4 md:px-8 min-h-screen pb-12">
    <!-- Header Section -->
    <div class="py-8 animate__animated animate__fadeIn">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <div class="p-3 bg-indigo-100 rounded-full text-indigo-600">
                <i class="fas fa-concierge-bell"></i>
            </div>
            {% if LANGUAGE_CODE == 'ar' %}تعديل الخدمة{% else %}Edit Service{% endif %}
        </h1>
    </div>

    <!-- Form Section -->
    <div class="animate-[fadeIn_0.8s_ease-out_0.2s_both] bg-white rounded-xl shadow-xl p-6 mx-2 md:mx-0 mb-8">
        <form method="post" enctype="multipart/form-data" class="w-full">
            {% csrf_token %}

            <!-- Image Upload Section -->
            <div class="mb-8">
                <div class="relative w-full bg-gray-100 rounded-xl overflow-hidden" id="image-upload-area">
                    {% if form.instance.image %}
                    <div id="current-image-container" class="relative">
                        <img src="{{ form.instance.image.url }}" class="w-full h-64 object-cover" alt="Current Service Image">
                        <button type="button" onclick="removeCurrentImage()" class="absolute top-4 right-4 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors duration-300">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                    {% else %}
                    <div id="upload-placeholder" class="h-64 flex items-center justify-center text-center p-6">
                        <div>
                            <div class="mx-auto w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                                <i class="bi bi-image text-indigo-600 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-700 mb-2">
                                {% if LANGUAGE_CODE == 'ar' %}اسحب وأفلت صورة الخدمة هنا{% else %}Drag & drop service image here{% endif %}
                            </h3>
                            <p class="text-gray-500 mb-4">
                                {% if LANGUAGE_CODE == 'ar' %}أو{% else %}or{% endif %}
                            </p>
                            <label for="service-image" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-300 cursor-pointer">
                                {% if LANGUAGE_CODE == 'ar' %}اختر صورة{% else %}Select Image{% endif %}
                            </label>
                        </div>
                    </div>
                    {% endif %}
                    <input type="file" id="service-image" accept="image/*" class="hidden" />
                    <input type="hidden" name="service_image_data" id="service-image-data">
                    <input type="hidden" name="remove_current_image" id="remove-current-image" value="false">
                </div>
            </div>

            <!-- Form Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div>
                    <!-- Service Title -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}عنوان الخدمة{% else %}Service Title{% endif %}
                        </label>
                        {{ form.title }}
                    </div>

                    <!-- Service Description -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}وصف الخدمة{% else %}Service Description{% endif %}
                        </label>
                        {{ form.desc }}
                    </div>
                </div>

                <!-- Right Column -->
                <div>
                    <!-- Price and Pricing Period -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                {% if LANGUAGE_CODE == 'ar' %}السعر{% else %}Price{% endif %}
                            </label>
                            {{ form.price }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                {% if LANGUAGE_CODE == 'ar' %}فترة التسعير{% else %}Pricing Period{% endif %}
                            </label>
                            {{ form.pricing_period_months }}
                        </div>
                    </div>

                    <!-- Discounted Price -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}سعر التخفيض{% else %}Discounted Price{% endif %}
                        </label>
                        <input type="number" name="discounted_price"
                               value="{% if form.instance.discounted_price %}{{ form.instance.discounted_price }}{% endif %}"
                               step="0.01"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-300 hover:border-gray-400">
                    </div>

                    <!-- Price Summary Display -->
                    <div class="mb-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-200">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}ملخص الأسعار{% else %}Price Summary{% endif %}
                        </h4>
                        <div id="price-summary" class="text-sm text-gray-600">
                            <div class="flex justify-between mb-1">
                                <span>{% if LANGUAGE_CODE == 'ar' %}السعر الشهري:{% else %}Monthly Price:{% endif %}</span>
                                <span id="monthly-price">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>{% if LANGUAGE_CODE == 'ar' %}إجمالي أيام الاشتراك:{% else %}Total Subscription Days:{% endif %}</span>
                                <span id="total-days">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Coaches Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}الموظفون المسؤولون{% else %}Responsible Employees{% endif %}
                        </label>
                        <select name="coaches" id="id_coaches" multiple class="select2">
                            {% for coach in form.fields.coaches.queryset %}
                            <option value="{{ coach.id }}"
                                    {% if coach.id|stringformat:"s" in selected_coach_ids %}selected{% endif %}>
                            {{ coach }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Service Classification -->
                    <div class="mb-6">
                        <label for="classification" class="block text-sm font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}تصنيف الخدمة{% else %}Service Classification{% endif %}
                        </label>
                        <select name="classification" id="id_classification" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-colors duration-300 hover:border-gray-400">
                            <option value="">
                                {% if LANGUAGE_CODE == 'ar' %}اختر التصنيف{% else %}Select Classification{% endif %}
                            </option>
                            {% for classification in form.fields.classification.queryset %}
                            <option value="{{ classification.id }}"
                                    {% if classification.id|stringformat:"s" == selected_classification_id %}selected{% endif %}>
                            {{ classification }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Duration -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% if LANGUAGE_CODE == 'ar' %}المدة (بالدقائق){% else %}Duration (in minutes){% endif %}
                        </label>
                        <input type="number" name="duration" value="{{ form.instance.duration }}" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-300 hover:border-gray-400">
                    </div>

                    <!-- Enable Service Toggle -->
                    <div class="mb-6 flex items-center">
                        <label class="flex items-center cursor-pointer">
                            <div class="relative">
                                {{ form.is_enabled }}
                                <span class="toggle-label"></span>
                            </div>
                            <span class="ml-3 text-sm font-medium text-gray-700">
                                {% if LANGUAGE_CODE == 'ar' %}تفعيل الخدمة{% else %}Enable Service{% endif %}
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
                <a href="{% url 'viewServices' %}"
                   class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-300 font-medium">
                    {% if LANGUAGE_CODE == 'ar' %}إلغاء{% else %}Cancel{% endif %}
                </a>
                <button type="submit"
                        class="px-6 py-2 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-lg hover:from-indigo-600 hover:to-indigo-700 transition-all duration-300 font-medium shadow-md hover:shadow-lg">
                    {% if LANGUAGE_CODE == 'ar' %}تحديث الخدمة{% else %}Update Service{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    /* Form Input Styles */
    #id_title, #id_desc, #id_price, #id_pricing_period_months, #id_coaches {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      transition: all 0.3s;
      background-color: #f8fafc;
    }

    #id_title:focus, #id_desc:focus, #id_price:focus, #id_pricing_period_months:focus, #id_coaches:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
      background-color: white;
    }

    #id_title:hover, #id_desc:hover, #id_price:hover, #id_pricing_period_months:hover, #id_coaches:hover {
      border-color: #a5b4fc;
      background-color: white;
    }

    #id_desc {
      min-height: 120px;
    }

    /* Toggle Switch */
    #id_is_enabled {
      width: 0;
      height: 0;
      opacity: 0;
      position: absolute;
    }

    #id_is_enabled + .toggle-label {
      display: inline-block;
      width: 3rem;
      height: 1.5rem;
      background-color: #e2e8f0;
      border-radius: 9999px;
      position: relative;
      transition: all 0.3s;
    }

    #id_is_enabled + .toggle-label:after {
      content: '';
      position: absolute;
      top: 0.125rem;
      left: 0.125rem;
      width: 1.25rem;
      height: 1.25rem;
      background-color: white;
      border-radius: 50%;
      transition: all 0.3s;
    }

    #id_is_enabled:checked + .toggle-label {
      background-color: #6366f1;
    }

    #id_is_enabled:checked + .toggle-label:after {
      transform: translateX(1.5rem);
    }

    /* Drag and Drop Area */
    #image-upload-area {
      border: 2px dashed #c7d2fe;
      transition: all 0.3s;
    }

    #image-upload-area:hover {
      border-color: #818cf8;
      background-color: #f0f4ff;
    }

    #image-upload-area.drag-over {
      border-color: #6366f1;
      background-color: #e0e7ff;
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
       $('.select2').select2();
       updatePriceSummary(); // Initial calculation
    });

    // Price calculation functionality
    function updatePriceSummary() {
        const priceInput = document.getElementById('id_price');
        const discountedPriceInput = document.querySelector('input[name="discounted_price"]');
        const pricingPeriodSelect = document.getElementById('id_pricing_period_months');

        const price = parseFloat(priceInput.value) || 0;
        const discountedPrice = parseFloat(discountedPriceInput.value) || 0;
        const pricingPeriod = parseInt(pricingPeriodSelect.value) || 1;

        const effectivePrice = discountedPrice > 0 ? discountedPrice : price;
        const monthlyPrice = effectivePrice / pricingPeriod;
        const totalDays = pricingPeriod * 30;

        document.getElementById('monthly-price').textContent = monthlyPrice.toFixed(2);
        document.getElementById('total-days').textContent = totalDays + ' days';
    }

    // Add event listeners for price calculation
    document.getElementById('id_price').addEventListener('input', updatePriceSummary);
    document.querySelector('input[name="discounted_price"]').addEventListener('input', updatePriceSummary);
    document.getElementById('id_pricing_period_months').addEventListener('change', updatePriceSummary);

    // Image Upload Functionality
    const imageUploadArea = document.getElementById('image-upload-area');
    const serviceImageInput = document.getElementById('service-image');
    const currentImageContainer = document.getElementById('current-image-container');
    const uploadPlaceholder = document.getElementById('upload-placeholder');

    // Handle drag and drop if no current image
    if (!currentImageContainer) {
      imageUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageUploadArea.classList.add('drag-over');
      });

      imageUploadArea.addEventListener('dragleave', () => {
        imageUploadArea.classList.remove('drag-over');
      });

      imageUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        imageUploadArea.classList.remove('drag-over');

        if (e.dataTransfer.files.length) {
          serviceImageInput.files = e.dataTransfer.files;
          handleImageUpload(e.dataTransfer.files[0]);
        }
      });
    }

    // Handle file selection
    serviceImageInput.addEventListener('change', (e) => {
      if (e.target.files.length) {
        handleImageUpload(e.target.files[0]);
      }
    });

    // Process the uploaded image
    function handleImageUpload(file) {
      if (file.type.match('image.*')) {
        const reader = new FileReader();

        reader.onload = function(e) {
          // Store base64 data in hidden input
          document.getElementById('service-image-data').value = e.target.result;

          // Show preview
          if (currentImageContainer) {
            currentImageContainer.innerHTML = `
              <img src="${e.target.result}" class="w-full h-64 object-cover" alt="Service Image">
              <button type="button" onclick="removeCurrentImage()" class="absolute top-4 right-4 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors duration-300">
                <i class="bi bi-trash-fill"></i>
              </button>
            `;
          } else {
            uploadPlaceholder.innerHTML = `
              <img src="${e.target.result}" class="w-full h-64 object-cover" alt="Service Image">
              <button type="button" onclick="removeUploadedImage()" class="absolute top-4 right-4 bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors duration-300">
                <i class="bi bi-trash-fill"></i>
              </button>
            `;
          }
        };

        reader.readAsDataURL(file);
      }
    }

    // Remove current image
    function removeCurrentImage() {
      document.getElementById('remove-current-image').value = 'true';
      currentImageContainer.remove();

      // Show upload placeholder
      const placeholder = document.createElement('div');
      placeholder.id = 'upload-placeholder';
      placeholder.className = 'h-64 flex items-center justify-center text-center p-6';
      placeholder.innerHTML = `
        <div>
          <div class="mx-auto w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mb-4">
            <i class="bi bi-image text-indigo-600 text-2xl"></i>
          </div>
          <h3 class="text-lg font-medium text-gray-700 mb-2">
            {% if LANGUAGE_CODE == 'ar' %}اسحب وأفلت صورة الخدمة هنا{% else %}Drag & drop service image here{% endif %}
          </h3>
          <p class="text-gray-500 mb-4">
            {% if LANGUAGE_CODE == 'ar' %}أو{% else %}or{% endif %}
          </p>
          <label for="service-image" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-300 cursor-pointer">
            {% if LANGUAGE_CODE == 'ar' %}اختر صورة{% else %}Select Image{% endif %}
          </label>
        </div>
      `;
      imageUploadArea.appendChild(placeholder);

      // Re-add event listeners
      setupDragAndDrop();
    }

    // Remove uploaded image (before saving)
    function removeUploadedImage() {
      serviceImageInput.value = '';
      document.getElementById('service-image-data').value = '';
      uploadPlaceholder.innerHTML = `
        <div>
          <div class="mx-auto w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mb-4">
            <i class="bi bi-image text-indigo-600 text-2xl"></i>
          </div>
          <h3 class="text-lg font-medium text-gray-700 mb-2">
            {% if LANGUAGE_CODE == 'ar' %}اسحب وأفلت صورة الخدمة هنا{% else %}Drag & drop service image here{% endif %}
          </h3>
          <p class="text-gray-500 mb-4">
            {% if LANGUAGE_CODE == 'ar' %}أو{% else %}or{% endif %}
          </p>
          <label for="service-image" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-300 cursor-pointer">
            {% if LANGUAGE_CODE == 'ar' %}اختر صورة{% else %}Select Image{% endif %}
          </label>
        </div>
      `;
    }

    // Setup drag and drop events
    function setupDragAndDrop() {
      const placeholder = document.getElementById('upload-placeholder');
      if (placeholder) {
        placeholder.addEventListener('dragover', (e) => {
          e.preventDefault();
          imageUploadArea.classList.add('drag-over');
        });

        placeholder.addEventListener('dragleave', () => {
          imageUploadArea.classList.remove('drag-over');
        });

        placeholder.addEventListener('drop', (e) => {
          e.preventDefault();
          imageUploadArea.classList.remove('drag-over');

          if (e.dataTransfer.files.length) {
            serviceImageInput.files = e.dataTransfer.files;
            handleImageUpload(e.dataTransfer.files[0]);
          }
        });
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      setupDragAndDrop();
    });
</script>
{% endblock %}